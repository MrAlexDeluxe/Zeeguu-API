<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <link rel="stylesheet" type="text/css"
          href=" {{ url_for('static', filename='css/graphs/learner_graph/learner_graph.css') }} ">
</head>

<body>

<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script>

    // fetching learner_stats_data from the server and parsing(nesting) it for d3js library
    var learner_stats_data = JSON.parse({% block body %}{{ learner_stats_data|safe }}{% endblock %});

    var learner_stats_data_nested = d3.nest()
            .key(function (entry) {
                return entry.Status;
            })
            .entries(learner_stats_data);

    // end of the fetching and parsing learner_stats_data


    // setting up graph and its parameters
    var WIDTH = 1200;
    var HEIGHT = 500;

    var learner_graph = d3.select("line_graph")
            .append("svg")
            .attr("width", WIDTH)
            .attr("height", HEIGHT);

    // offsets of the graph
    var MARGINS = {
        top: 50,
        right: 50,
        bottom: 50,
        left: 50
    };

    var lSpace = WIDTH / learner_stats_data_nested.length; // offset for the labels(legends) below the graph

    var month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    var date_of_today = new Date();

    var year = date_of_today.getFullYear();
    var month = date_of_today.getMonth();

    // in this case we don't care about precise day(date) ,because only months and year are used for this graph
    var date_one_year_ago = new Date(year-1, month, 1);

    var xScale = d3.time.scale()
            .range([MARGINS.left, WIDTH - MARGINS.right])
            .domain ([ date_one_year_ago, date_of_today ]);

    var yScale = d3.scale.linear()
            .range([HEIGHT - MARGINS.top, MARGINS.bottom])
            .domain([
                d3.min(learner_stats_data, function (entry) {return entry.words;}),
                d3.max(learner_stats_data, function (entry) {return entry.words;})
            ]);

    var xAxis = d3.svg.axis()
            .scale(xScale)
            .orient("bottom")
            .tickFormat(d3.time.format("%b %Y"));

    var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left");

    // draw both axes with indicators
    learner_graph.append("svg:g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
            .call(xAxis);

    learner_graph.append("svg:g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + (MARGINS.left) + ",0)")
            .call(yAxis);

    // generates the line path for the graph
    var line_gen = d3.svg.line()
            .x(function (entry) {
                var entry_month_number = month_names.indexOf(entry.date.split(" ")[0])+1;
                var entry_year = entry.date.split(" ")[1];
                return xScale(new Date(entry_month_number+".01."+entry_year));
            })
            .y(function (entry) {
                return yScale(entry.words);
            })
            .interpolate("basis");

    learner_stats_data_nested.forEach(function (entry, index) {

        // generates how dark or light should be the color of the line, depending of the lines array order
        var color_tone = 50 - 20 * index ;

        // draw the lines itself
        learner_graph.append('svg:path')
                .attr('d', line_gen(entry.values))
                .attr('stroke', function (entry) {
                    return "hsl(" + 200 + ",100%, "+ color_tone +"% )";
                })
                .attr('stroke-width', 2)
                .attr('id', 'line_' + entry.key)
                .attr('fill', 'none');

        // draw legends below the graph
        learner_graph.append("text")
                .attr("x", (lSpace / 2) + index * lSpace)
                .attr("y", HEIGHT-10)
                .style("fill", "hsl(" + 200 + ",100%, "+ color_tone +"% )")
                .attr("class", "legend")
                .on('click', function () {
                    var active = entry.active ? false : true;
                    var opacity = active ? 0 : 1;
                    d3.select("#line_" + entry.key).style("opacity", opacity);
                    entry.active = active;
                })
                .text(entry.key);
    });


</script>
</body>